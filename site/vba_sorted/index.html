
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.9">
    
    
      
        <title>VBA Code - Budget Dance</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#vba-code" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Budget Dance" class="md-header__button md-logo" aria-label="Budget Dance" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Budget Dance
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              VBA Code
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Budget Dance" class="md-nav__button md-logo" aria-label="Budget Dance" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Budget Dance
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Tools to map accounting data to long term plans
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../appendix/" class="md-nav__link">
        Appendix
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../data_from_moneydance/" class="md-nav__link">
        Data from Moneydance
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../fcast/" class="md-nav__link">
        Design and use of fcast.xlsm
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        Setting up the spreadsheet
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../vba_index/" class="md-nav__link">
        VBA Code Summary
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        VBA Code
      </a>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="vba-code">VBA Code</h1>
<pre><code class="language-vbscript">Attribute VB_Name = &quot;Module1&quot;
Public Const dbg As Boolean = True
Option Base 0

Function acct_who1(acct As String, Optional num_chars As Integer = 1) As String
'return the first initial of the owner of an account in format type - who - firm
    Dim parts() As String
    parts = Split(acct, &quot; - &quot;)
    who = parts(1)
    acct_who1 = Left(who, num_chars)
End Function

Function add_wdraw(acct As String, y_year As String, Optional is_fcst As Boolean = False) As Variant
'grab the actual transfers in (positive) our out(negative)
'ignoring the optional is_fcst argument - instead: compute it
    Dim line As String, tbl As String, prefix As String
    is_fcst = is_forecast(y_year)
    prefix = &quot;Actl&quot;
    If is_fcst Then prefix = &quot;Fcst&quot;
    add_wdraw = 0
    acct_type = get_val(acct, &quot;tbl_accounts&quot;, &quot;Type&quot;)
    tbl = get_val(acct, &quot;tbl_accounts&quot;, prefix &amp; &quot;_source_tab&quot;)
    line = get_val(acct, &quot;tbl_accounts&quot;, prefix &amp; &quot;_source&quot;)
    If (&quot;I&quot; = acct_type) And Not is_fcst Then line = &quot;add/wdraw&quot; &amp; line ' complete key for investment actuals

    If line &lt;&gt; &quot;zero&quot; Then  ' keyword to enable forecasting of zeros
        value = get_val(line, tbl, y_year)
        add_wdraw = value
    End If
End Function

Function age_as_of_date(inits As String, dt As Date) As Double
'return the age attained by an account owner in a given year
    Dim dob As Date, eoy As Date
    Dim diff As Double, age As Double
    dob = get_val(inits, &quot;tbl_people&quot;, &quot;DOB&quot;)
    diff = (dt - dob) / 365.25
    age = Application.WorksheetFunction.Round(diff, 3)
    age_as_of_date = age
End Function

Function age_of(inits As String, y_year As String) As Integer
'return the age attained by an account owner in a given year
    Dim dob As Date, eoy As Date
    Dim diff As Double, age As Integer
    dob = get_val(inits, &quot;tbl_people&quot;, &quot;DOB&quot;)
    eoy = DateSerial(IntYear(y_year), 12, 31)
    diff = (eoy - dob) / 365.25
    age = Int(Application.WorksheetFunction.RoundDown(diff, 0))
    age_of = age
End Function

Function agg(y_year As String, by_tag As Variant, Optional agg_method = &quot;sum&quot;, Optional tag_col_name As String = &quot;Tag&quot;) As Double
' Aggregate (default is sum) up the values in the table containing the calling cell for a year where the by_tag is found in the tag column.
' Use of this can help avoid the hard coding of addresses into formulas
' By default the tag column is &quot;tag&quot; but an alternate can be provided
' Other agg_methods are &quot;min&quot; and &quot;max&quot;
    Dim agg_val As Double

    Dim tbl As ListObject
    Dim point As range, val_rng As range, tag_col As range
    Set point = Application.caller
    Set tbl = point.ListObject
    Set tag_rng = tbl.ListColumns(tag_col_name).range
    Set val_rng = tbl.ListColumns(y_year).range
    Select Case agg_method
    Case &quot;sum&quot;
        agg_val = Application.WorksheetFunction.SumIfs(val_rng, tag_rng, by_tag)
    Case &quot;min&quot;
        agg_val = Application.WorksheetFunction.MinIfs(val_rng, tag_rng, by_tag)
    Case &quot;max&quot;
        agg_val = Application.WorksheetFunction.MaxIfs(val_rng, tag_rng, by_tag)
    End Select
    agg = agg_val


End Function

Function ANN(account As String, account_owner As String, y_year As String) As Double
'DEPRECATED - USE annuity instead
'return a year's value for an annuity stream based on the prior year's end balance
'does not properly handle partial years
    Dim this_year As Integer, age As Integer
    Dim prior_end_bal As Double, term As Double, result As Double, anny_rate As Double, anny_dur As Double
    Dim anny_start As Date, o1 As String, n As Integer
    Dim dur_parm As String
    this_year = IntYear(y_year)
    prior_end_bal = get_val(&quot;End Bal&quot; &amp; account, &quot;tbl_balances&quot;, &quot;Y&quot; &amp; this_year - 1)
    age = age_of(account_owner, y_year) - 1
    o1 = Left(account_owner, 1)
    anny_rate = get_val(&quot;anny_rate&quot;, &quot;tbl_retir_parms&quot;, o1)
    dur_parm = &quot;anny_dur&quot;  ' hack picks different duration for roth
    If InStr(account, &quot;Roth&quot;) &gt; 0 Then dur_parm = &quot;roth_dur&quot;
    anny_dur = get_val(dur_parm, &quot;tbl_retir_parms&quot;, o1)
    anny_start = get_val(&quot;anny_start&quot;, &quot;tbl_retir_parms&quot;, o1)
    n = anny_dur - (this_year - year(anny_start))
    result = 0
    If n &gt; 0 Then
        result = -Application.WorksheetFunction.Pmt(anny_rate, n, prior_end_bal)
    End If
    ANN = result
End Function

Function annuity(account As String, y_year As String) As Double
'return a year's value for an annuity stream based on the prior year's end balance
'fetches the start date, duration and annual annuity rate from tbl_retir_vals
'rounds to whole number
    Dim anny_start As Date
    Dim duration As Integer, this_year As Integer
    Dim annual_rate As Double, anny_rate As Double
    this_year = IntYear(y_year)
    prior_end_bal = get_val(&quot;End Bal&quot; &amp; account, &quot;tbl_balances&quot;, &quot;Y&quot; &amp; this_year - 1)
    anny_start = get_val(account, &quot;tbl_retir_vals&quot;, &quot;Start Date&quot;)
    duration = get_val(account, &quot;tbl_retir_vals&quot;, &quot;Anny Dur Yrs&quot;)
    anny_rate = get_val(account, &quot;tbl_retir_vals&quot;, &quot;Anny Rate&quot;)

    n = duration - (this_year - year(anny_start))
    result = 0
    If n &gt; 0 Then
        result = -Application.WorksheetFunction.Pmt(anny_rate, n, prior_end_bal)
        factor = mo_apply(anny_start, y_year) ' TODO put end date on this call
        result = factor * result
        result = Application.WorksheetFunction.Round(result, 0)
    End If
    annuity = result
End Function

Sub calc_retir()
'iterate through the years to calc retirement streams based on balances from prior year
'prior balance from balances feeds current retirement, which feeds aux, which feeds current balances
'iande depends on retirement as well and taxes depend on iande
    Dim rcols As range, rcell As range
    Dim tbls(4) As ListObject
    Dim tbl_names(4) As String
    Dim ws_names(4) As String
    Dim msg As String
    log (&quot;-----------------------------&quot;)
    log (&quot;Entering manual calculation mode.&quot;)
    Application.Calculation = xlCalculationManual
    tbl_names(0) = &quot;tbl_retir_vals&quot;
    tbl_names(1) = &quot;tbl_aux&quot;
    tbl_names(2) = &quot;tbl_balances&quot;
    tbl_names(3) = &quot;tbl_iande&quot;
    tbl_names(4) = &quot;tbl_taxes&quot;
    msg = &quot;&quot;
    For i = LBound(tbl_names) To UBound(tbl_names)
        ws_names(i) = ws_for_table_name(tbl_names(i))
        Set tbls(i) = ThisWorkbook.Worksheets(ws_names(i)).ListObjects(tbl_names(i))
        If Len(msg) &gt; 0 Then msg = msg &amp; &quot;,&quot;
        If i = UBound(tbl_names) Then msg = msg &amp; &quot; and &quot;
        msg = msg &amp; ws_names(i)

    Next i

    Set rcols = tbls(0).HeaderRowRange
    Set col = tbls(0).ListColumns(&quot;yearly&quot;)
    col.range.Dirty
    col.range.Calculate
    log (&quot;Retirement yearly column refreshed.&quot;)
    For Each rcell In rcols

        If InStr(rcell.value, &quot;Y20&quot;) = 1 Then
            For i = LBound(tbls) To UBound(tbls)
                Set col = tbls(i).ListColumns(rcell.value)
                t_name = tbls(i).Name
                col.range.Dirty
                col.range.Calculate
                log (&quot;  &quot; &amp; t_name)
            Next i
            log (&quot;Calculated &quot; &amp; msg &amp; &quot; for &quot; &amp; rcell.value)
         End If
    Next rcell
    log (&quot;Entering automatic calculation mode.&quot;)
    log (&quot;-----------------------------&quot;)
    Application.Calculation = xlCalculationAutomatic

End Sub

Sub calc_table()
'Testing forced calc of table
    Dim rcols As range, rcell As range
    Dim tbl As ListObject
    Dim tbl_name As String
    Dim ws_name As String
    Dim msg As String
    log (&quot;-----------------------------&quot;)
    log (&quot;Entering manual calculation mode.&quot;)
    Application.Calculation = xlCalculationManual
    tbl_name = &quot;tbl_balances&quot;
    ws_name = ws_for_table_name(tbl_name)
    Set tbl = ThisWorkbook.Worksheets(ws_name).ListObjects(tbl_name)


    tbl.range.Dirty
    tbl.range.Calculate
    log (tbl_name &amp; &quot; refreshed.&quot;)
    log (&quot;Entering automatic calculation mode.&quot;)
    log (&quot;-----------------------------&quot;)
    Application.Calculation = xlCalculationAutomatic

End Sub

Function d2s(dt As Date) As String
    d2s = Format(dt, &quot;mm/dd/yyyy&quot;)
End Function

Function endbal(acct As String, y_year As String) As Variant
'compute the end balance for an account for a year
    Dim rate As Variant
    Dim val As Variant
    open_bal = get_val(&quot;Start bal&quot; &amp; acct, &quot;tbl_balances&quot;, y_year)
    adds = get_val(&quot;Add/Wdraw&quot; &amp; acct, &quot;tbl_balances&quot;, y_year)
    rlzd = get_val(&quot;Rlz Int/Gn&quot; &amp; acct, &quot;tbl_balances&quot;, y_year)
    unrlzd = get_val(&quot;Unrlz Gn/Ls&quot; &amp; acct, &quot;tbl_balances&quot;, y_year)
    val = open_bal + adds + rlzd + unrlzd
    endbal = val

End Function

Function Fed_Tax_CapGn(tax_Year As Integer, taxable_Income As Double, totCapGn As Double) As Double
'computes the resulting federal tax with capital gains portion at 15%
'the input should include qualified dividends

    Dim base As Double, result As Double, cgt As Double
    base = Federal_Tax(tax_Year, taxable_Income - totCapGn)
    cgt = 0.15 * totCapGn
    result = base + cgt
    Fed_Tax_CapGn = result

End Function

Function Federal_Tax(tax_Year As Integer, taxable_Income As Double) As Double
'Calculate the federal income tax for a given year and taxable income amount
'gets a result of zero if year not in the table.
    Dim result As Double
    Dim tbl_name As String
    Dim tbl As ListObject
    Dim lr As ListRow
    Dim rng As range
    Dim yr As Integer
    Dim ti As Double
    Dim rt As Double
    Dim sb As Double

    tbl_name = &quot;tbl_fed_tax&quot;
    ws = ws_for_table_name(tbl_name)
    Set tbl = ThisWorkbook.Worksheets(ws).ListObjects(tbl_name)
    result = 0
    For Each lr In tbl.ListRows()
        Set rng = lr.range
        yr = rng.Cells(1, 1).value
        ti = rng.Cells(1, 2).value
        rt = rng.Cells(1, 3).value
        sb = rng.Cells(1, 4).value
        If tax_Year = yr Then
            If taxable_Income &gt; ti Then
                result = (rt * taxable_Income) - sb
                result = Round(result, 0)
            End If
        End If
    Next lr
    Federal_Tax = result
End Function

Function gain(acct As String, y_year As String, realized As Boolean) As Variant
'For bank accounts and investments, return the realized or unrealized gain for an account for a year for actual or forecast
'Other types of accounts return zero.
' for investments actuals, use the values from invest_actl
' for bank account actuals use the row in iande defined by the 'bank_interest' value on the general (state) table
    Dim rate As Variant
    Dim val As Variant
    Dim col_name As String
    Dim interest_row As String

    gain = 0 ' return zero if not investment or bank account
    account_type = get_val(acct, &quot;tbl_accounts&quot;, &quot;Type&quot;)
    If Not ((account_type = &quot;I&quot;) Or (account_type = &quot;B&quot;)) Then
        Exit Function
    End If
    If realized Then
        col_name = &quot;Rlz share&quot;
        prefix = &quot;Rlz Int/Gn&quot;
    Else
        col_name = &quot;Unrlz share&quot;
        prefix = &quot;Unrlz Gn/Ls&quot;
    End If
    is_fcst = is_forecast(y_year)
    If is_fcst Then
        open_bal = get_val(&quot;Start bal&quot; &amp; acct, &quot;tbl_balances&quot;, y_year)
        rate = get_val(&quot;Rate&quot; &amp; acct, &quot;tbl_balances&quot;, y_year)
        alloc = get_val(acct, &quot;tbl_accounts&quot;, col_name)
        val = open_bal * rate * alloc
    Else ' actuals
        If account_type = &quot;I&quot; Then
            val = get_val(prefix &amp; acct, &quot;tbl_invest_actl&quot;, y_year)
        Else 'banks
            If realized Then
                interest_row = get_val(&quot;bank_interest&quot;, &quot;tbl_gen_state&quot;, &quot;value&quot;)
                val = get_val(interest_row, &quot;tbl_iande&quot;, y_year)
            Else ' banks never have unrealized
                val = 0
            End If
        End If
    End If
    gain = val

End Function

Function get_val(line_key As Variant, tbl_name As String, col_name As String) As Variant
'Fetches a value from a given table (it must be an actual worksheet table
'If the line is not found in the table, a zero is returned.

    Dim value As Variant, rng As Variant
    Dim caller As range
    Dim address As String

    Set caller = Application.caller()
    address = caller.Worksheet.Name &amp; &quot;!&quot; &amp; caller(1, 1).address
    ws = ws_for_table_name(tbl_name)

    'now get the data
    With ThisWorkbook.Worksheets(ws)
        Set rng = .ListObjects(tbl_name).HeaderRowRange
        Dim cr As range

        On Error GoTo ErrHandler1
        col = Application.WorksheetFunction.Match(col_name, rng, False)
        Set rng = .ListObjects(tbl_name).DataBodyRange
        On Error GoTo ErrHandler
        value = Application.WorksheetFunction.VLookup(line_key, rng, col, False)
        If IsEmpty(value) Then
            value = 0
        End If

    End With
    get_val = value
    Exit Function

ErrHandler:
    log (&quot;[&quot; &amp; address &amp; &quot; ] get_val: &quot; &amp; line_key &amp; &quot; not found in &quot; &amp; tbl_name &amp; &quot;, using zero as value for &quot; &amp; col_name)
    Dim lkrange As range
    If False Then 'use this to debug missing lines. e.g. tbl_name = &quot;tbl_taxes&quot; Then
        Set lkrange = ThisWorkbook.Worksheets(ws).ListObjects(tbl_name).ListColumns(1).DataBodyRange
        Debug.Print (lkrange.Count)
        For Each c In lkrange.Cells
            log (c.value)
        Next
    End If
    get_val = 0
    Exit Function
ErrHandler1:
    log (&quot;[ &quot; &amp; address &amp; &quot; ] get_val: &quot; &amp; Err.Number &amp; &quot; &quot; &amp; Err.Description)
    log (&quot;Trying to locate column: &quot; &amp; col_name &amp; &quot; in table &quot; &amp; tbl_name)
    log (&quot;line is &quot; &amp; line_key)
End Function

Function IntYear(yval) As Integer
'strips off the Y on the argument (eg Y2019) and returns an integer
    y = 0 + Right(yval, 4)
    IntYear = y
End Function

Function is_forecast(y_year As String) As Boolean
'determine if this year is a forecast year
    ffys = get_val(&quot;first_forecast&quot;, &quot;tbl_gen_state&quot;, &quot;Value&quot;)
    ffy = IntYear(ffys)
    ty = IntYear(y_year)
    r = ty &gt;= ffy
    is_forecast = r
End Function

Sub log(txt As String)
    If dbg Then
        Debug.Print (Format(Now, &quot;mm/dd/yyyy HH:mm:ss: &quot;) &amp; txt)
    End If
End Sub

Function LUMP(account As String, y_year As String) As Double
'return the expected lump sum payment for an account based on the prior year's end balance + any items in the aux table
'for the current year (items that begin with the account name)
    Dim this_year As Integer, tbl_name As String
    Dim prior_end_bal As Double, adj As Double, result As Double
    Dim tbl As ListObject, crit_col As ListColumn, val_col As ListColumn
    this_year = IntYear(y_year)
    prior_end_bal = get_val(&quot;End Bal&quot; &amp; account, &quot;tbl_balances&quot;, &quot;Y&quot; &amp; this_year - 1)
    criteria = account
    tbl_name = &quot;tbl_aux&quot;
    ws_name = ws_for_table_name(tbl_name)
    Set tbl = ThisWorkbook.Worksheets(ws_name).ListObjects(tbl_name)
    Set crit_col = tbl.ListColumns(&quot;Accum_by&quot;)
    Set val_col = tbl.ListColumns(y_year)
    adj = Application.WorksheetFunction.SumIf(crit_col.range, criteria, val_col.range)
    result = adj + prior_end_bal
    LUMP = result
End Function

Function MedicarePrem(b_or_d As Integer, year As String, inflation As Variant, Optional magi As Variant = -1) As Variant
'Given a year (as Y+year), return annual part b premium or part D surcharge (IRMAA)
'normally look up the modifed adjusted gross from 2 years ago, but if its supplied, like for a test, use that instead.
'b_or_d isa 1 for part B premium or 2 for Part D surcharge
'If the year is not in the table, then the largest year lower than that given will be used
'and the resulting value will include inflation.  Inflation is given as 1.0x so it can be used directly
    Dim yr As Integer
    Dim tbl_name As String, ws_name As String, magi_yr As String
    Dim tbl As ListObject
    Dim lr As ListRow, rng As range
    Dim infl As Variant

    yr = IntYear(year)
    If magi = -1 Then
        magi_yr = y_offset(year, -2)
        magi = get_val(&quot;Adjusted Gross&quot;, &quot;tbl_taxes&quot;, magi_yr)
    End If
    magi = Application.WorksheetFunction.Max(1, magi)
    tbl_name = &quot;tbl_part_b&quot;
    ws_name = ws_for_table_name(tbl_name)
    Set tbl = ThisWorkbook.Worksheets(ws_name).ListObjects(tbl_name)
    Set yr_col = tbl.ListColumns(&quot;year&quot;)
    y = Application.WorksheetFunction.VLookup(yr, yr_col.range, 1, True) ' latest year for which we have data
    MedicarePrem = 0 'in case the if never succeeds
    For Each lr In tbl.ListRows()
        Set rng = lr.range
        ry = rng.Cells(1, 1).value
        rl = rng.Cells(1, 2).value
        rh = rng.Cells(1, 3).value
        valu = rng.Cells(1, 3 + b_or_d).value
        pw = (yr - y)
        If (ry = y And rl &lt; magi And rh &gt;= magi) Then
            p = valu * 12
            infl = CDbl(Application.WorksheetFunction.Power(inflation, pw))
            MedicarePrem = p * infl
            Exit For
        End If
    Next
End Function

Function mo_apply(start_date As Date, y_year As String, Optional end_mdy As String = &quot;&quot;) As Double
'Get a rational number that represents the number of months that apply in a particular year given the start date and optionally an end date
'The end date is a string since there is a bug in the Mac Excel.
'The end date represents the month of the last period to include.  The day is ignored and the last day of the month is used.
    Dim result As Double, distance As Double, sign As Integer, months As Integer
    Dim ed As Date, sd As Date
    If end_mdy = &quot;&quot; Then
        ed = DateSerial(3000, 12, 31) 'the default since the literal is not working on MacExcel
    Else
        mdy = Split(end_mdy, &quot;/&quot;)
        ed = DateSerial(mdy(2), mdy(0) + 1, 1) - 1
    End If
    ed = Application.WorksheetFunction.Min(ed, DateSerial(IntYear(y_year), 12, 31))
    sd = Application.WorksheetFunction.Max(start_date, DateSerial(IntYear(y_year), 1, 1))
    distance = (ed - sd) / (365.25 / 12)
    months = Round(distance, 0)
    months = Application.WorksheetFunction.Min(12, months)
    months = Application.WorksheetFunction.Max(0, months)
    result = months / 12
    mo_apply = result
End Function

Function PartBPrem(year As String, inflation As Variant, Optional magi As Variant = -1) As Variant
'Given a year (as Y+year) and the modifed adjusted gross (2 years ago) return annual part b premium
'If the year is not in the table, then the largest year lower than that given will be used
'and the resulting value will include inflation.  Inflation is given as 1.0x so it can be used directly
    PartBPrem = MedicarePrem(1, year, inflation, magi)
End Function

Function PartDSurcharge(year As String, inflation As Variant, Optional magi As Variant = -1) As Variant
'Given a year (as Y+year) and the modifed adjusted gross (2 years ago) return annual part D surcharge
'If the year is not in the table, then the largest year lower than that given will be used
'and the resulting value will include inflation.  Inflation is given as 1.0x so it can be used directly
    PartDSurcharge = MedicarePrem(2, year, inflation, magi)
End Function

Function prior_value(line As String) As Variant
' Get the prior years' value for this line. Suitable only for year columns.
    Dim prior_col As String
    Dim value As Variant
    Dim table As String
    Dim range As range
    Set range = Application.caller
    table = range.ListObject.Name
    prior_col = y_offset(this_col_name(), -1)
    value = get_val(line, table, prior_col)
    prior_value = value
End Function

Function retir_agg(y_year As String, typ As String, Optional who As String = &quot;*&quot;, Optional firm As String = &quot;*&quot;, Optional election As String = &quot;*&quot;) As Double
'get the sum of values from the retirement table for a year and type, optionally further qualified by who, firm and/or election.
'wild cards are OK as are Excel functions like &quot;&lt;&gt;&quot; prependedto the values.  For instance &quot;MEDIC*&quot; for type gets all medical assuming rows coded that way
'NOTE all the criteria fields must have values - suggest using NA if there is no value such as for an election.

    Dim this_year As Integer, tbl_name As String
    Dim result As Double
    Dim tbl As ListObject, crit_col1 As ListColumn, crit_col2 As ListColumn, val_col As ListColumn
    Dim criteria1 As String, criteria2 As String

    tbl_name = &quot;tbl_retir_vals&quot;
    ws_name = ws_for_table_name(tbl_name)
    Set tbl = ThisWorkbook.Worksheets(ws_name).ListObjects(tbl_name)
    Set crit_col1 = tbl.ListColumns(&quot;Type&quot;)
    Set crit_col2 = tbl.ListColumns(&quot;Who&quot;)
    Set crit_col3 = tbl.ListColumns(&quot;Firm&quot;)
    Set crit_col4 = tbl.ListColumns(&quot;Election&quot;)
    Set val_col = tbl.ListColumns(y_year)
    result = Application.WorksheetFunction.SumIfs(val_col.range, _
        crit_col1.range, typ, _
        crit_col2.range, who, _
        crit_col3.range, firm, _
        crit_col4.range, election)
    retir_agg = result

End Function

Function retir_med(inits As String, y_year As String) As Double
'return the forecast medical expenses including premium and deductible for person with initials init given a year
    retir_med = retir_agg(y_year, &quot;MEDIC*&quot;, inits)
End Function

Function retir_parm(code As String, who As String) As Variant
'Get a retirement paramenter given code and code (G or V)
    Dim rng As range
    On Error GoTo ErrHandler
    sht = &quot;retireparms&quot;
    cl = InStr(1, &quot;abGV&quot;, who, vbTextCompare)
    With ThisWorkbook.Worksheets(sht)
        Set rng = .range(&quot;Table3[code]&quot;)
        rw = Application.WorksheetFunction.Match(code, rng, False)
        rw = rw + rng.row - 1
        s = sht &amp; &quot;!&quot; &amp; .Cells(rw, cl).address
        v = .range(s)
        retir_parm = v
    End With
    Exit Function

ErrHandler:
    log (&quot;retir_parm: &quot; &amp; Err.Description &amp; &quot; (&quot; &amp; Err.Number &amp; &quot;)&quot;)
    log (&quot;Looking for: &quot; &amp; code &amp; &quot; who:&quot; &amp; who)

End Function

Function RMD_1(account As String, account_owner As String, y_year As String, Optional death_year As Integer = 0) As Double
'return the req minimum distribution table 1 result for a year for a given account, owner (GBD or VEC) and year.
'if death year is not given then this function treat this as spousal inheritance
'if death year is given the treat this as a beneficiary inheritance
    Dim this_year As Integer, age As Integer
    Dim prior_end_bal As Double, life_expectancy As Double, result As Double
    this_year = IntYear(y_year)
    prior_end_bal = get_val(&quot;End Bal&quot; &amp; account, &quot;tbl_balances&quot;, &quot;Y&quot; &amp; this_year - 1)
    If death_year = 0 Then ' for spousal use actual age this year
        age = age_of(account_owner, y_year)
        life_expectancy = get_val(age, &quot;tbl_rmd_1&quot;, &quot;Life Expectancy&quot;)
    Else ' work with the age at year after death for beneficiary type
        age = age_of(account_owner, &quot;Y&quot; &amp; (death_year + 1))
        life_expectancy = get_val(age, &quot;tbl_rmd_1&quot;, &quot;Life Expectancy&quot;)
        life_expectancy = life_expectancy - (this_year - (death_year + 1)) 'factor is reduced by one for each succeeding distribution year.
    End If
    result = prior_end_bal / life_expectancy
    RMD_1 = result
End Function

Function rolling_avg(table As String, key As String, this_y_year As String, lookback As Integer) As Double
'Look back at previous columns and average the numeric values found there, ignoring non-numerics
'Return the average
Dim y_year As String
this_year = IntYear(this_y_year)
tot = 0
cnt = 0
For y = this_year - lookback To this_year - 1
    y_year = &quot;Y&quot; &amp; y
    value = get_val(key, table, y_year)
    If Not value = 0 Then
        tot = tot + value
        cnt = cnt + 1
    End If
Next y
If cnt &lt;&gt; 0 Then
    rolling_avg = tot / cnt
Else
    rolling_avg = 0
End If
End Function

Function simple_return(account As String, y_year As String) As Double
'return the rlzd gain divided by the average of the start and end balances (or zero)
sb = get_val(&quot;Start Bal&quot; &amp; account, &quot;tbl_balances&quot;, y_year)
eb = get_val(&quot;End Bal&quot; &amp; account, &quot;tbl_balances&quot;, y_year)
rg = get_val(&quot;Rlz Int/Gn&quot; &amp; account, &quot;tbl_balances&quot;, y_year)
urg = get_val(&quot;Unrlz Gn/Ls&quot; &amp; account, &quot;tbl_balances&quot;, y_year)
av = (sb + eb) / 2
If av = 0 Then
  result = 0
Else
  result = (rg + urg) / av
End If
simple_return = result
End Function

Function sort_tax_table()
'make sure the federal tax tables are sorted properly
    Dim tbl_name As String
    tbl_name = &quot;tbl_fed_tax&quot;
    ws = ws_for_table_name(tbl_name)
    Dim tbl As ListObject
    Set tbl = ThisWorkbook.Worksheets(ws).ListObjects(tbl_name)
    Dim year_column As range, range_column As range
    Set year_column = range(tbl_name &amp; &quot;[Year]&quot;)
    Set range_column = range(tbl_name &amp; &quot;[Range]&quot;)
    With tbl.sort
       .SortFields.Clear
       .SortFields.Add key:=year_column, SortOn:=xlSortOnValues, Order:=xlAscending
       .SortFields.Add key:=range_column, SortOn:=xlSortOnValues, Order:=xlAscending
       .Header = xlYes
       .Apply
    End With
End Function

Sub test_fed_tax()
    Dim r As Double, c As Double

    zt = &quot;not passed&quot;
    r = Federal_Tax(2150, 9999)
    If 0 = r Then zt = &quot;passed&quot;
    n = 74031
    pt = &quot;not passed&quot;
    r = Federal_Tax(2020, 350000)
    If r = n Then pt = &quot;passed&quot;
    n = 72331
    ct = &quot;not passed&quot;
    c = Fed_Tax_CapGn(2020, 350000, 10000)
    If c = n Then ct = &quot;passed&quot;
    Debug.Print (&quot;Zero test: &quot; &amp; zt)
    Debug.Print (&quot;Positive test:&quot; &amp; pt)
    Debug.Print (&quot;Capital gains test:&quot; &amp; ct)

End Sub

Sub test_get_val()
    Dim tbl_name As String
    Dim line_name As String
    Dim y_year As String
    Debug.Print (get_val(&quot;Expenses:T:Soc Sec - TOTAL&quot;, &quot;tbl_iande_actl&quot;, &quot;Y2018&quot;))
    Debug.Print (get_val(&quot;End BalMortgage - Nationstar&quot;, &quot;tbl_balances&quot;, &quot;Y2019&quot;))

 End Sub

Sub test_LUMP()
    Dim val As Double
    val = LUMP(&quot;401K - GBD - TRV&quot;, &quot;Y2022&quot;)
    Debug.Print (val)
End Sub

Sub test_medicarePrem()
Dim test_cases() As Variant
Dim yr As String
Dim infl As Variant
Dim magi As Variant
test_cases() = Array(Array(2021, 1#, 10000), Array(2022, 1#, 182001), Array(2022, 1#, 400000), Array(2023, 1.02, 75000))
log (&quot;Part B tests&quot;)
For i = LBound(test_cases) To UBound(test_cases)
    yr = &quot;Y&quot; &amp; test_cases(i)(0)
    magi = test_cases(i)(2)
    infl = test_cases(i)(1)
    partB = PartBPrem(yr, infl, magi)
    partD = PartDSurcharge(yr, infl, magi)
    msg = &quot;Input: year=&quot; &amp; test_cases(i)(0) &amp; &quot; magi=&quot; &amp; magi &amp; &quot; inflation=&quot; &amp; infl &amp; &quot;   Output: &quot; &amp; partB &amp; &quot;  Part D: &quot; &amp; partD
    log (msg)
Next


End Sub

Sub test_mo_apply()
Dim test_cases() As Variant
Dim test_case As Variant
Dim yr As String
Dim start_date As Date, end_date As String, result As Double
test_cases() = Array( _
Array(3, 2022, 2022), _
Array(12, 2025, 2025), _
Array(3, 2022, 2022, 11, 2022), _
Array(3, 2022, 2025, 9, 2025), _
Array(3, 2022, 2022, 8, 2022) _
)
log (&quot;mo_apply tests&quot;)
For i = LBound(test_cases) To UBound(test_cases)
    test_case = test_cases(i)
    start_date = DateSerial(test_case(1), test_case(0), 1)

    yr = &quot;Y&quot; &amp; test_case(2)
    end_date = &quot;-none-&quot;
    If UBound(test_case) &gt; 2 Then
        end_date = test_case(3) &amp; &quot;/1/&quot; &amp; test_case(4)
        result = mo_apply(start_date, yr, end_date)
    Else
        result = mo_apply(start_date, yr)
    End If
    msg = &quot;Input: year=&quot; &amp; yr &amp; &quot; start/end dates = &quot; &amp; start_date &amp; &quot; &quot; &amp; end_date &amp; &quot;   Output: &quot; &amp; result
    log (msg)
Next i
End Sub

Sub test_retir_med()
Dim test_cases() As Variant
Dim yr As String, who As String, result As Double
test_cases() = Array(Array(&quot;GBD&quot;, &quot;Y2022&quot;), Array(&quot;VEC&quot;, &quot;Y2026&quot;))
log (&quot;retir_med tests&quot;)
For i = LBound(test_cases) To UBound(test_cases)
    who = test_cases(i)(0)
    yr = test_cases(i)(1)
    result = retir_med(who, yr)
    msg = &quot;Input: year=&quot; &amp; yr &amp; &quot; who=&quot; &amp; who &amp; &quot;   Output: &quot; &amp; result
    log (msg)
Next


End Sub

Sub test_sort()
    sort_tax_table
End Sub

Function this_col_name() As String
'return the caller's column name, assuming the cell is in a table.
'Otherwise generates a #VALUE  error
'Use to make formulas more portable

    Dim point As range
    Dim list_ojb As ListObject
    Dim cols As ListColumns
    Dim offset As Integer, col_ix As Integer

    Set point = Application.caller
    Set list_obj = point.ListObject
    Set cols = list_obj.ListColumns
    offset = list_obj.range(1, 1).Column - 1
    col_ix = offset + point.Column
    this_col_name = cols(col_ix)
End Function

Function unrlz(acct As String, y_year As String) As Variant
'compute the unrealized gain or loss for an account for a year, assuming end bal is fixed
    Dim open_bal As Variant, adds As Variant, rlzd As Variant, end_bal As Variant
    Dim val As Variant
    open_bal = get_val(&quot;Start bal&quot; &amp; acct, &quot;tbl_balances&quot;, y_year)
    adds = get_val(&quot;Add/Wdraw&quot; &amp; acct, &quot;tbl_balances&quot;, y_year)
    rlzd = get_val(&quot;Rlz Int/Gn&quot; &amp; acct, &quot;tbl_balances&quot;, y_year)
    end_bal = get_val(&quot;End bal&quot; &amp; acct, &quot;tbl_balances&quot;, y_year)
    val = end_bal - (open_bal + adds + rlzd)
    unrlz = val

End Function

Function ws_for_table_name(tbl_name As String) As String
' find out what worksheet the named table occurs on
    With ThisWorkbook.Worksheets(&quot;utility&quot;)
        Set rng = .ListObjects(&quot;tbl_table_map&quot;).DataBodyRange
        ws = Application.WorksheetFunction.VLookup(tbl_name, rng, 2, False)
    End With
    ws_for_table_name = ws
End Function

Function y_offset(y_year As String, offset As Integer) As String
'given a y_year offset it by the amount given, producing a new y_year
    y = IntYear(y_year)
    r = &quot;Y&quot; &amp; y + offset
    y_offset = r
End Function
</code></pre>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../vba_index/" class="md-footer__link md-footer__link--prev" aria-label="Previous: VBA Code Summary" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              VBA Code Summary
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>