# Defined Excel Lambda functions

| name           | comment                                                                                                                                       | formula                                                                                                                                                          |
|:---------------|:----------------------------------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| AGE            | Return the age attained by an account owner with inits in a given year                                                                        | =LAMBDA(inits,yr,ROUNDDOWN(((DATE(yr,12,31)-DOB(inits))/365.25),0))                                                                                              |
| AGI            | Returns the adjusted gross income for a year.  To be used in a table in a year col. Call with tbl_taxes[Ynnnn].                               | =LAMBDA(ycol,XLOOKUP("Adjusted gross - TOTAL",tbl_taxes[Key],ycol))                                                                                              |
| DAY_COUNT      | The number of days from the first date to the last date, inclusive. Call with 2 element array.                                                | =LAMBDA(arr,MAX(0,1+SUM({-1,1}*arr)))                                                                                                                            |
| DEFAULT_DATE   | Given a value that is a date or blank, return the blank to the horizon, the given date (if not blank)                                         | =LAMBDA(d,IF(ISBLANK(d),HORIZON(),d))                                                                                                                            |
| DIV0           | Performs normal division except div by 0 returns 0                                                                                            | =LAMBDA(n,d,IF(d=0,0,n/d))                                                                                                                                       |
| DOB            | Get date of birth for initials                                                                                                                | =LAMBDA(inits,XLOOKUP(inits,tbl_people[Initials],tbl_people[DOB]))                                                                                               |
| FIRST_LAST     | Return the first and last date in a year, given an integer year.                                                                              | =LAMBDA(y,HSTACK(DATE(y,1,1),DATE(y,12,31)))                                                                                                                     |
| HORIZON        | Returns the last date in the planning horizon                                                                                                 | =LAMBDA(DATE(0+RIGHT(TAKE(tbl_balances[#Headers],1,-1),4),12,31))                                                                                                |
| IIEF           | For 1st only, opening balance for acct v. Used in the investment iande ratios. Call with column in balances.                                  | =LAMBDA(v,col,XLOOKUP(v &":Start Bal",tbl_balances[Key],col))                                                                                                    |
| IIES           | Except for 1st, opening balance for this acct v. Used in the investment iande ratios. Call with column in balances.                           | =LAMBDA(v,col,XLOOKUP(v &" - TOTAL",tbl_balances[Key],col))                                                                                                      |
| IIEV           | Get the numerator for key k. Use in the invest iande ratios. Call with column in values.                                                      | =LAMBDA(k,col,XLOOKUP(k,tbl_invest_iande_values[Key],col))                                                                                                       |
| LAST_TWO_PARTS | Return the last two parts of a multipart key separated by colon, as a string with a colon separator.                                          | =LAMBDA(key,TEXTJOIN(":",FALSE,TAKE(TEXTSPLIT(key,":"),1,-2)))                                                                                                   |
| LE_BEN         | Life expectancy for a beneficiary (not a spouse). Call with election, who.                                                                    | =LAMBDA(election,who,LET(e,TEXTSPLIT(election,"-"),dy,0+TAKE(e,1,-1),g,AGE(who,dy),le,XLOOKUP(g,tbl_rmd_1[Age],tbl_rmd_1[Life Expectancy]),le-(THIS_YEAR()-dy))) |
| LE_SPOUSE      | Life expectancy for a spouse (not a beneficiary). Call with who.                                                                              | =LAMBDA(who,LET(g,AGE(who,THIS_YEAR()),le,XLOOKUP(g,tbl_rmd_1[Age],tbl_rmd_1[Life Expectancy]),le))                                                              |
| MAX_MIN        | Return the max of the 1st column and the min of the 2nd column                                                                                | =LAMBDA(arr,HSTACK(MAX(CHOOSECOLS(arr,1)),MIN(CHOOSECOLS(arr,2))))                                                                                               |
| MC_RATES       | Returns the best annual medicare rate table as an array. To be run in a table year column. Called with the tbl_part_b[#Data] as the argument. | =LAMBDA(all_rates,FILTER(all_rates,CHOOSECOLS(all_rates,1)=YEAR_FOR_TBL(all_rates)))                                                                             |
| MONTHLY_PARTB  | Returns the monthly part B premium for this year. Called with the tbl_part_b[#Data] and agi as the arguments.                                 | =LAMBDA(arr,agi,LET(rates,MC_RATES(arr),m,CHOOSECOLS(rates,3),b,CHOOSECOLS(rates,4),XLOOKUP(agi,m,b,0,1)))                                                       |
| MONTHLY_PARTD  | Returns the monthly part D premium surcharge for this year.  Called with the tbl_part_b[#Data] as and agi the arguments.                      | =LAMBDA(arr,agi,LET(rates,MC_RATES(arr),m,CHOOSECOLS(rates,3),b,CHOOSECOLS(rates,5),XLOOKUP(agi,m,b,0,1)))                                                       |
| PORTION        | The number of days in this year where this row applies divided by 365 or 366 for leap years.                                                  | =LAMBDA(s,e,y,DAY_COUNT(MAX_MIN(VSTACK(HSTACK(s,DEFAULT_DATE(e)),FIRST_LAST(y))))/(1+SUM(FIRST_LAST(y)*{-1,1})))                                                 |
| THIS_COL_HDR   | In a table, get this column's header name. Call with tbl_xxx[#Headers].                                                                       | =LAMBDA(h,CHOOSECOLS(h,COLUMN()-(TAKE(COLUMN(h),1,1)-1)))                                                                                                        |
| THIS_YEAR      | Suitable to use in tables in columns that represent years. Returns the year as a number.                                                      | =LAMBDA(0+RIGHT(this_col_name(),4))                                                                                                                              |
| TX_CALC_A      | Calc tax using add type tax table. Call with 3 col tax table, taxable income                                                                  | =LAMBDA(tt,ti,LET(m,ti-TX_PRV_BK(tt,ti),tx,TX_THS_BK(tt,ti)*EXPAND(m,1,2,1),SUM(tx)))                                                                            |
| TX_CALC_B      | Calc tax using subtract type tax table. Call with 3 col tax table, taxable income, capgn                                                      | =LAMBDA(tt,ti,cg,SUM(XLOOKUP(ti-cg,CHOOSECOLS(tt,1),CHOOSECOLS(tt,2,3),0,-1)*EXPAND((ti-cg),1,2,-1))+0.15*cg)                                                    |
| TX_CT          | Compute CT income tax. Call with 4-col tx tbl, yr, txbl income                                                                                | =LAMBDA(tbl,yr,ti,TX_CALC_A(TX_TB(tbl,yr),ti))                                                                                                                   |
| TX_FED         | Compute federal income tax. Call with 4-col tx tbl, yr, txbl income, cap gn                                                                   | =LAMBDA(tbl,yr,ti,cg,TX_CALC_B(TX_TB(tbl,yr),ti,cg))                                                                                                             |
| TX_PRV_BK      | Return the high edge or the prior bracket. Call with 3 col tax table, taxable income .                                                        | =LAMBDA(tt,ti,LET(b,DROP(tt,0,-2),TAKE(FILTER(b,b<ti),-1,1)))                                                                                                    |
| TX_TB          | Return the 3 col tax table for a year. Call with the 4 col tax table, year                                                                    | =LAMBDA(arr,yr,DROP(FILTER(arr,CHOOSECOLS(arr,1)=yr),0,1))                                                                                                       |
| TX_THS_BK      | Return bracket 3rd and 4th col of this bracket. Call with 3 col tax table, taxable inc.                                                       | =LAMBDA(tt,ti,XLOOKUP(ti,CHOOSECOLS(tt,1),CHOOSECOLS(tt,2,3),0,1))                                                                                               |
| YEAR_FOR_TBL   | return current year or highest year in given table. For use in year columns. Call like this - YEAR_FOR_TBL(tbl_part_b)                        | =LAMBDA(arr,MIN(THIS_YEAR(),MAX(CHOOSECOLS(arr,1))))                                                                                                             |